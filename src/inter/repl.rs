use anyhow::Error;

use crate::inter::environment::Environment;
use crate::inter::evaluator::{rust::RustEvaluator, Evaluator};

use super::ast::*;
use super::lexer::*;
use std::io::{self, Write};

const WELCOME_MESSAGE: &str = "
\tРќѕРќѕРЋЌ   РќѕРќѕРЋЌ РќѕРќѕРќѕРќѕРќѕРќѕРЋЌ РќѕРќѕРќѕРЋЌ   РќѕРќѕРЋЌРќѕРќѕРќѕРќѕРќѕРќѕРЋЌ РќѕРќѕРќѕРќѕРќѕРќѕРќѕРЋЌРќѕРќѕРЋЌ     
\tРќѕРќѕРЋЉ   РќѕРќѕРЋЉРќѕРќѕРЋћРЋљРЋљРЋљРќѕРќѕРЋЌРќѕРќѕРќѕРќѕРЋЌ  РќѕРќѕРЋЉРќѕРќѕРЋћРЋљРЋљРќѕРќѕРЋЌРќѕРќѕРЋћРЋљРЋљРЋљРЋљРЋЮРќѕРќѕРЋЉ     
\tРќѕРќѕРЋЉ   РќѕРќѕРЋЉРќѕРќѕРЋЉ   РќѕРќѕРЋЉРќѕРќѕРЋћРќѕРќѕРЋЌ РќѕРќѕРЋЉРќѕРќѕРЋЉ  РќѕРќѕРЋЉРќѕРќѕРќѕРќѕРќѕРЋЌ  РќѕРќѕРЋЉ     
\tРЋџРќѕРќѕРЋЌ РќѕРќѕРЋћРЋЮРќѕРќѕРЋЉ   РќѕРќѕРЋЉРќѕРќѕРЋЉРЋџРќѕРќѕРЋЌРќѕРќѕРЋЉРќѕРќѕРЋЉ  РќѕРќѕРЋЉРќѕРќѕРЋћРЋљРЋљРЋЮ  РќѕРќѕРЋЉ     
\t РЋџРќѕРќѕРќѕРќѕРЋћРЋЮ РЋџРќѕРќѕРќѕРќѕРќѕРќѕРЋћРЋЮРќѕРќѕРЋЉ РЋџРќѕРќѕРќѕРќѕРЋЉРќѕРќѕРќѕРќѕРќѕРќѕРЋћРЋЮРќѕРќѕРќѕРќѕРќѕРќѕРќѕРЋЌРќѕРќѕРќѕРќѕРќѕРќѕРќѕРЋЌ
\t  РЋџРЋљРЋљРЋљРЋЮ   РЋџРЋљРЋљРЋљРЋљРЋљРЋЮ РЋџРЋљРЋЮ  РЋџРЋљРЋљРЋљРЋЮРЋџРЋљРЋљРЋљРЋљРЋљРЋЮ РЋџРЋљРЋљРЋљРЋљРЋљРЋљРЋЮРЋџРЋљРЋљРЋљРЋљРЋљРЋљРЋЮ
\t                                                    
Welcome to the Vondel interpreter!
Start writing anything!
";

const PROMPT: &str = "­ЪћЦ ";
const DRAGON: &str = r"
РађРађРађРађРађРађРађРађРађРађРађРађРађРађРађРађРађРађРађРађРађРађРађРађРБђРацРБ▓РаЪРаЂРађРађРађРађРађРађРађРађРађРБаРађРађРађРађРађРађРађРађРађРађРађ
РађРађРађРађРађРађРађРађРађРађРађРађРађРађРађРађРађРађРађРађРађРАаРаќРаІРбђРаъРаЂРађРађРађРађРађРађРађРађРађРбђРаюРАЄРађРађРађРађРађРађРађРађРађРађРађ
РађРађРађРађРађРађРађРађРађРађРађРађРађРађРађРађРађРађРађРА░РаіРађРађРАаРаІРађРађРађРађРађРађРађРађРађРађРБаРаіРА░РаЂРађРађРађРађРађРађРађРађРађРађРађ
РађРађРађРађРађРађРађРађРађРађРађРађРађРађРађРађРађРађРА╝РаЂРађРађРАюРаЂРађРађРађРађРађРађРађРађРБђРацРаџРаЂРАюРаЂРађРађРађРађРађРађРађРађРађРађРађРађ
РађРађРађРађРађРађРађРађРађРађРађРађРађРађРађРађРађРађРАЄРађРађРбИРађРађРађРађРбђРБђРБђРацРаќРаѕРађРађРбђРАюРађРАђРађРађРађРађРађРађРађРађРађРађРађРађ
РађРађРађРађРађРађРађРађРађРађРађРађРађРађРађРађРбђРаћРаЊРа▓РбцРБИРањРБіРБГРаЏРаЅРађРађРађРађРађРбђРБаРб┐РАХРаЏРаЂРађРађРађРађРађРађРађРађРађРађРађРађ
РађРађРађРађРађРађРађРађРађРађРађРађРађРађРађРбаРаЄРађРађРађРађРБ╣РајРађРађРаЉРАёРађРбђРАаРаћРбіРАЦРб║РаІРађРађРађРађРађРађРађРађРађРађРађРађРађРађРађ
РађРађРађРађРађРађРађРађРађРађРађРађРађРађРБаРајРађРађРађРБаРаъРаЂРађРађРађРбђРБЙРаІРаЂРБаРаъРаЂРађРбИРАђРађРађРађРађРађРађРађРађРађРађРађРађРађРађРађ
РађРађРађРађРађРађРађРађРађРађРађРађРађРб░РаЃРађРАаРаіРАюРаЂРађРађРађРбђРАіРаЂРаЂРађРбіРАђРађРађРађРБђРБЅРБЊРБдРАцРацРађРађРађРађРађРађРађРађРађРађРађ
РађРађРађРађРађРађРађРађРађРађРађРађРађРаўРАцРаіРаЂРаИРађРађРађРАаРАќРАЮРађРађРађРађРађРаѕРбЅРАЕРаГРањРбІРАЪРаЂРађРађРађРађРађРађРађРађРађРађРађРађРађ
РађРађРађРађРађРађРађРађРађРађРађРађРађРАИРаЂРађРађРађРаЉРањРаЏРањРаІРаЂРађРађРађРађРађРађРаўРацРБђРАђРаѕРБЄРађРађРађРађРађРађРађРађРађРађРађРађРађРађ
РађРађРађРађРађРађРађРађРађРађРађРБђРаюРаЂРађРађРађРађРађРађРбђРБђРацРаёРађРађРађРА░РаџРбДРаЅРањРањРа«РайРБЙРБдРБђРађРађРађРађРађРађРађРађРађРађРађРађ
РађРађРађРађРађРађРађРађРађРбаРаІРаЂРАаРБќРаѓРађРађРађРАаРаІРаЅРађРАђРађРађРбђРА┤РаЂРађРаИРАёРађРађРађРађРАЄРаЎРбїРаЅРађРађРађРађРађРађРађРађРађРађРађ
РађРађРађРађРађРађРађРађРађРбИРађРаўРаљРаЂРБђРАаРаћРаІРБђРБђРА┤РаџРаЊРАХРБъРБЅРБђРБђРАаРбцРаЄРађРађРађРб░РБЃРАђРаѕРб│РАђРађРађРађРађРађРађРађРађРађРађ
РађРађРађРађРађРађРађРађРађРаѕРбДРБђРБаРАіРаЂРАђРБаРаъРаЂРађРађРађРАюРаЂРађРађРађРађРађРАюРађРађРађРађРБ┐РађРаѕРаЉРбёРб│РађРађРађРађРађРађРађРађРађРађ
РађРађРађРађРађРађРађРађРађРађРађРађРа░РБйРб╗РАЈРаЂРађРађРађРбђРаъРаЉРадРацРацРацРаёРАИРаЂРађРађРађРбИРаЅРБєРађРађРаўРАЙРађРађРађРађРађРађРађРађРађРађ
РађРађРађРађРађРађРађРађРађРађРађРађРађРа╣РађРаЃРађРађРађРбђРбЈРађРађРађРађРађРађРА░РаЂРађРађРађРађРбИРађРаўРАёРађРађРаЂРађРађРађРађРађРађРађРађРађРађ
РађРађРађРађРађРађРађРађРађРађРађРађРађРађРађРађРађРађРађРбИРађРаЉРадРацРацРаёРб▓РаЂРађРађРађРађРађРаўРБєРБђРБ╣
";
fn print_parser_errors(errors: Vec<Error>) {
    println!("{}", DRAGON);
    println!("Woops! We ran into some dragon problems here!");
    for e in errors {
        println!("{}", e);
    }
}

pub fn start(evaluator: Box<dyn Evaluator>, _verbose: bool) {
    println!("{}", WELCOME_MESSAGE);
    let mut env = Environment::new();
    loop {
        print!("{PROMPT}");
        io::stdout().flush().unwrap();
        let mut buf = String::new();

        match io::stdin().read_line(&mut buf) {
            Ok(0) => break,
            Ok(_) => {}
            Err(e) => panic!("{e}"),
        };

        let start = std::time::Instant::now();

        let toks = Lexer::new(buf).get_deez_toks();
        let program = Parser::new(&toks).get_deez_program();

        if !program.errors.is_empty() {
            print_parser_errors(program.errors);
            continue;
        }

        let evaluated = evaluator.eval(&program, &mut env);
        match evaluated {
            Ok(obj) => println!("{}\n", obj.inspect()),
            Err(e) => println!("{}\n", e),
        }

        let finish = std::time::Instant::now();
        println!("Evaluated in {:?}", finish.duration_since(start));
    }
}
